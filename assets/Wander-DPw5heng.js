import{c as u,a4 as ge,a5 as de,a6 as ve,a7 as oe,a8 as ke,a9 as Me,S as Le,o as ae,W as Se,m as Pe,n as Te,G as ze,g as _e,J as re,M as le,U as We,O as ce,aa as Ae,K as Be,ab as Ie,ac as Ce,l as Ee}from"./three.module-DxqIPYNp.js";import{G as De}from"./GLTFLoader-CeTFqpKO.js";import{_ as Re,r as qe,o as Ge,f as Oe,c as Fe,a as He,p as Ve,e as Je,b as w}from"./index-DqCDvAQH.js";class J{constructor(e=new u(0,0,0),t=new u(0,1,0),i=1){this.start=e,this.end=t,this.radius=i}clone(){return new J(this.start.clone(),this.end.clone(),this.radius)}set(e,t,i){this.start.copy(e),this.end.copy(t),this.radius=i}copy(e){this.start.copy(e.start),this.end.copy(e.end),this.radius=e.radius}getCenter(e){return e.copy(this.end).add(this.start).multiplyScalar(.5)}translate(e){this.start.add(e),this.end.add(e)}checkAABBAxis(e,t,i,s,n,a,l,c,d){return(n-e<d||n-i<d)&&(e-a<d||i-a<d)&&(l-t<d||l-s<d)&&(t-c<d||s-c<d)}intersectsBox(e){return this.checkAABBAxis(this.start.x,this.start.y,this.end.x,this.end.y,e.min.x,e.max.x,e.min.y,e.max.y,this.radius)&&this.checkAABBAxis(this.start.x,this.start.z,this.end.x,this.end.z,e.min.x,e.max.x,e.min.z,e.max.z,this.radius)&&this.checkAABBAxis(this.start.y,this.start.z,this.end.y,this.end.z,e.min.y,e.max.y,e.min.z,e.max.z,this.radius)}}const E=new u,D=new u,H=new u,R=new u,x=new ge,Y=new de,Ne=new de,V=new ve,q=new J,je=new u,Ue=new u,Ke=new u,Xe=1e-10;function Ye(b,e,t=null,i=null){const s=je.copy(b.end).sub(b.start),n=Ue.copy(e.end).sub(e.start),a=Ke.copy(e.start).sub(b.start),l=s.dot(n),c=s.dot(s),d=n.dot(n),y=n.dot(a),v=s.dot(a);let g,k;const z=c*d-l*l;if(Math.abs(z)<Xe){const L=-y/d,W=(l-y)/d;Math.abs(L-.5)<Math.abs(W-.5)?(g=0,k=L):(g=1,k=W)}else g=(y*l+v*d)/z,k=(g*l-y)/d;k=Math.max(0,Math.min(1,k)),g=Math.max(0,Math.min(1,g)),t&&t.copy(s).multiplyScalar(g).add(b.start),i&&i.copy(n).multiplyScalar(k).add(e.start)}class Q{constructor(e){this.box=e,this.bounds=new oe,this.subTrees=[],this.triangles=[],this.layers=new ke}addTriangle(e){return this.bounds.min.x=Math.min(this.bounds.min.x,e.a.x,e.b.x,e.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,e.a.y,e.b.y,e.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,e.a.z,e.b.z,e.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,e.a.x,e.b.x,e.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,e.a.y,e.b.y,e.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,e.a.z,e.b.z,e.c.z),this.triangles.push(e),this}calcBox(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this}split(e){if(!this.box)return;const t=[],i=D.copy(this.box.max).sub(this.box.min).multiplyScalar(.5);for(let n=0;n<2;n++)for(let a=0;a<2;a++)for(let l=0;l<2;l++){const c=new oe,d=E.set(n,a,l);c.min.copy(this.box.min).add(d.multiply(i)),c.max.copy(c.min).add(i),t.push(new Q(c))}let s;for(;s=this.triangles.pop();)for(let n=0;n<t.length;n++)t[n].box.intersectsTriangle(s)&&t[n].triangles.push(s);for(let n=0;n<t.length;n++){const a=t[n].triangles.length;a>8&&e<16&&t[n].split(e+1),a!==0&&this.subTrees.push(t[n])}return this}build(){return this.calcBox(),this.split(0),this}getRayTriangles(e,t){for(let i=0;i<this.subTrees.length;i++){const s=this.subTrees[i];if(e.intersectsBox(s.box))if(s.triangles.length>0)for(let n=0;n<s.triangles.length;n++)t.indexOf(s.triangles[n])===-1&&t.push(s.triangles[n]);else s.getRayTriangles(e,t)}return t}triangleCapsuleIntersect(e,t){t.getPlane(x);const i=x.distanceToPoint(e.start)-e.radius,s=x.distanceToPoint(e.end)-e.radius;if(i>0&&s>0||i<-e.radius&&s<-e.radius)return!1;const n=Math.abs(i/(Math.abs(i)+Math.abs(s))),a=E.copy(e.start).lerp(e.end,n);if(t.containsPoint(a))return{normal:x.normal.clone(),point:a.clone(),depth:Math.abs(Math.min(i,s))};const l=e.radius*e.radius,c=Y.set(e.start,e.end),d=[[t.a,t.b],[t.b,t.c],[t.c,t.a]];for(let y=0;y<d.length;y++){const v=Ne.set(d[y][0],d[y][1]);if(Ye(c,v,H,R),H.distanceToSquared(R)<l)return{normal:H.clone().sub(R).normalize(),point:R.clone(),depth:e.radius-H.distanceTo(R)}}return!1}triangleSphereIntersect(e,t){if(t.getPlane(x),!e.intersectsPlane(x))return!1;const i=Math.abs(x.distanceToSphere(e)),s=e.radius*e.radius-i*i,n=x.projectPoint(e.center,E);if(t.containsPoint(e.center))return{normal:x.normal.clone(),point:n.clone(),depth:Math.abs(x.distanceToSphere(e))};const a=[[t.a,t.b],[t.b,t.c],[t.c,t.a]];for(let l=0;l<a.length;l++){Y.set(a[l][0],a[l][1]),Y.closestPointToPoint(n,!0,D);const c=D.distanceToSquared(e.center);if(c<s)return{normal:e.center.clone().sub(D).normalize(),point:D.clone(),depth:e.radius-Math.sqrt(c)}}return!1}getSphereTriangles(e,t){for(let i=0;i<this.subTrees.length;i++){const s=this.subTrees[i];if(e.intersectsBox(s.box))if(s.triangles.length>0)for(let n=0;n<s.triangles.length;n++)t.indexOf(s.triangles[n])===-1&&t.push(s.triangles[n]);else s.getSphereTriangles(e,t)}}getCapsuleTriangles(e,t){for(let i=0;i<this.subTrees.length;i++){const s=this.subTrees[i];if(e.intersectsBox(s.box))if(s.triangles.length>0)for(let n=0;n<s.triangles.length;n++)t.indexOf(s.triangles[n])===-1&&t.push(s.triangles[n]);else s.getCapsuleTriangles(e,t)}}sphereIntersect(e){V.copy(e);const t=[];let i,s=!1;this.getSphereTriangles(e,t);for(let n=0;n<t.length;n++)(i=this.triangleSphereIntersect(V,t[n]))&&(s=!0,V.center.add(i.normal.multiplyScalar(i.depth)));if(s){const n=V.center.clone().sub(e.center),a=n.length();return{normal:n.normalize(),depth:a}}return!1}capsuleIntersect(e){q.copy(e);const t=[];let i,s=!1;this.getCapsuleTriangles(q,t);for(let n=0;n<t.length;n++)(i=this.triangleCapsuleIntersect(q,t[n]))&&(s=!0,q.translate(i.normal.multiplyScalar(i.depth)));if(s){const n=q.getCenter(new u).sub(e.getCenter(E)),a=n.length();return{normal:n.normalize(),depth:a}}return!1}rayIntersect(e){if(e.direction.length()===0)return;const t=[];let i,s,n=1e100;this.getRayTriangles(e,t);for(let a=0;a<t.length;a++){const l=e.intersectTriangle(t[a].a,t[a].b,t[a].c,!0,E);if(l){const c=l.sub(e.origin).length();n>c&&(s=l.clone().add(e.origin),n=c,i=t[a])}}return n<1e100?{distance:n,triangle:i,position:s}:!1}fromGraphNode(e){return e.updateWorldMatrix(!0,!0),e.traverse(t=>{if(t.isMesh===!0&&this.layers.test(t.layers)){let i,s=!1;t.geometry.index!==null?(s=!0,i=t.geometry.toNonIndexed()):i=t.geometry;const n=i.getAttribute("position");for(let a=0;a<n.count;a+=3){const l=new u().fromBufferAttribute(n,a),c=new u().fromBufferAttribute(n,a+1),d=new u().fromBufferAttribute(n,a+2);l.applyMatrix4(t.matrixWorld),c.applyMatrix4(t.matrixWorld),d.applyMatrix4(t.matrixWorld),this.addTriangle(new Me(l,c,d))}s&&i.dispose()}}),this.build(),this}clear(){return this.box=null,this.bounds.makeEmpty(),this.subTrees.length=0,this.triangles.length=0,this}}const Qe=b=>(Ve("data-v-5a8df239"),b=b(),Je(),b),Ze=Qe(()=>w("div",{class:"movetip"},[w("p",null,"w -> 向前运动"),w("p",null,"s -> 向后运动"),w("p",null,"a -> 向左运动"),w("p",null,"d -> 向右运动"),w("p",null,"t -> 挥手"),w("p",null,"v -> 切换摄像头"),w("p",null,"j -> 跳舞"),w("p",null,"k -> 停止跳舞"),w("p",null,"空格 -> 跳起")],-1)),$e=[Ze],et={__name:"Wander",setup(b){let e=document.querySelector(".left-menu").offsetWidth||180,t=window.innerWidth-e,i=window.innerHeight,s=qe(null);const n=new Le,a=new ae(75,t/i,.1,1e3);a.position.set(0,5,10);const l=new ae(75,t/i,.1,1e3);l.position.set(0,5,-10);const c=new Se;c.setSize(t,i),c.shadowMap.enabled=!0,c.physicallyCorrectLights=!0;let d=new Pe(16777215,1);n.add(d);let y=new Te(16777215,1);y.castShadow=!0,y.position.set(50,25,10),n.add(y);let v=new ze,g=new _e(1e3,1e3),k=new re({color:16777215}),z=new le(g,k);z.rotation.x=-Math.PI/2,z.receiveShadow=!0,v.add(z);let L=(o,r)=>Math.floor(Math.random()*(r-o))+o;for(let o=0;o<100;o++){let r=L(2,5),h=L(2,5),f=new We(r,r,h),K=new re({color:16711680}),X=new le(f,K);X.position.set(L(-100,100),h/2,L(-100,100)),X.castShadow=!0,v.add(X)}n.add(v);const W=new Q;W.fromGraphNode(v);let S=new J(new u(0,.35,0),new u(0,1.35,0),.35);const m=new ce;m.position.set(0,0,0),n.add(m),a.position.set(0,2,-5),a.lookAt(m.position),l.position.set(0,2,5),l.lookAt(m.position);let M=new ce;M.add(a),M.add(l),m.add(M);let N=a,ue=-9.8,p=new u(0,0,0),A=new u(0,0,0),j=!1,he=new Ae(16777215,4473924,1);n.add(he);let G=null,fe=new URL("/assets/RobotExpressive-BhJ5TM2m.glb",import.meta.url).href,P={};new De().load(fe,o=>{o.scene,o.scene.scale.set(.5,.5,.5),o.scene.position.set(0,-.8,0),m.add(o.scene);let r=o.animations;G=new Be(o.scene),r.forEach((h,f)=>{let K=G.clipAction(h);P[h.name]=K,h.name=="Idle"||h.name=="Running"||h.name=="Walking"||h.name=="Dance"?(P[h.name].clampWhenFinished=!1,P[h.name].loop=Ie):(P[h.name].clampWhenFinished=!1,P[h.name].loop=Ce)}),o.scene.traverse(h=>{h.castShadow=!0})});let B=null,O=null,_=(o,r=.3)=>{O=B,B=P[o],O!=B&&(O&&O.fadeOut(r),B&&B.reset().setEffectiveTimeScale(1).setEffectiveWeight(1).fadeIn(r).play())},F=!1,I=!1,C=!1,T={},U=!1,Z=o=>{let r=P[o],h=r.getClip();return r&&h?h.duration:0},$=o=>{let r=o.code.toLocaleLowerCase();r=="space"&&!F&&(F=!0,p.y<=0&&_("Jump")),r=="keyj"&&!I&&(I=!0,_("Dance")),r=="keyk"&&I&&(I=!1),r=="keyt"&&!C&&(C=!0,_("Wave")),T[r]=!0,U=!0},ee=o=>{let r=o.code.toLocaleLowerCase();r=="space"&&F&&setTimeout(()=>{F=!1},Z("Jump")*800),T[r]=!1,U=!1,r=="keyv"&&(N=N==a?l:a),r=="keyt"&&C&&setTimeout(()=>{C=!1},Z("Wave")*800)},te=.0015,ne=o=>{m.rotation.y-=o.movementX*te,M.rotation.x+=o.movementY*te,M.rotation.x>Math.PI/8?M.rotation.x=Math.PI/8:M.rotation.x<-Math.PI/8&&(M.rotation.x=-Math.PI/8)},me=o=>{let r=s.value;r.requestPointerLock=r.requestPointerLock||r.mozRequestPointerLock||r.webkitRequestPointerLock,r.requestPointerLock&&r.requestPointerLock()},pe=o=>{let r=new u;if(m.getWorldDirection(r),new u,new u(0,0,.06).length(),T.keyw){A.z=1;let f=new u(0,0,0);m.getWorldDirection(f),p.add(f.multiplyScalar(o))}if(T.keys){A.z=1;let f=new u(0,0,0);m.getWorldDirection(f),p.add(f.multiplyScalar(-o))}if(T.keya){A.z=1;let f=new u(0,0,0);m.getWorldDirection(f),f.cross(m.up),p.add(f.multiplyScalar(-o))}if(T.keyd){A.z=1;let f=new u(0,0,0);m.getWorldDirection(f),f.cross(m.up),p.add(f.multiplyScalar(o))}T.space&&p.y==0&&(p.y=8)},ye=()=>{let o=W.capsuleIntersect(S);j=!1,o&&(j=o.normal.y>0,S.translate(o.normal.multiplyScalar(o.depth)))},we=o=>{let r=-.5;j?(p.y=0,U||p.addScaledVector(p,r)):p.y+=ue*o;let h=p.clone().multiplyScalar(o);S.translate(h),S.getCenter(m.position),ye();let f=Math.abs(p.x)+Math.abs(p.z);f>.1&&f<=5?_("Walking"):f>5?_("Running"):!I&&!C&&_("Idle")},xe=()=>{m.position.y<-20&&(S.start.set(0,2.35,0),S.end.set(0,3.35,0),S.radius=.35,p.set(0,0,0),A.set(0,0,0))};const be=new Ee;e=document.querySelector(".left-menu").offsetWidth||180;let se=()=>{t=window.innerWidth-e,i=window.innerHeight,a.aspect=t/i,a.updateProjectionMatrix(),c.setSize(t,i),c.setPixelRatio(window.devicePixelRatio)};Ge(()=>{s.value.appendChild(c.domElement),window.addEventListener("keydown",$),window.addEventListener("keyup",ee),s.value.addEventListener("mousemove",ne),s.value.addEventListener("mousedown",me),window.addEventListener("resize",se)}),Oe(()=>{window.removeEventListener("resize",se),window.removeEventListener("keydown",$),window.removeEventListener("keyup",ee),s.value.removeEventListener("mousemove",ne),s.value.removeEventListener("mousedown",()=>{let o=s.value;o.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,o.exitPointerLock&&o.exitPointerLock()})});function ie(){let o=be.getDelta();pe(o),we(o),xe(),G&&G.update(o),c.render(n,N),requestAnimationFrame(ie)}return ie(),(o,r)=>(He(),Fe("div",{id:"wanderScene",ref_key:"wanderScene",ref:s},$e,512))}},ot=Re(et,[["__scopeId","data-v-5a8df239"]]);export{ot as default};
